<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="leaveRecodeMapper">
	<select id="selectLeaveRecode" resultMap="lrResultSet">
		<![CDATA[
		select *
		from(
		    select *
		    from leave_recode
		    where m_id = #{id}
		    order by enroll_date desc
		)
		where rownum <= 3
		]]>
	</select>

	<resultMap type="LeaveRecode" id="lrResultSet">
		<id column="M_ID" property="mId"/>
		<!-- <id column="LEAVE_USE_DATE" property="leaveUseDate"/> -->
		<result column="LEAVE_REASON" property="leaveReason"/>
		<result column="LEAVE_TYPE" property="leaveType"/>
		<result column="LEAVE_STATUS" property="leaveStatus"/>	
		<result column="totalLeave" property="totalLeave"/>	
		<result column="usedLeave" property="usedLeave"/>	
		<result column="restLeveCount" property="restLeveCount"/>
	<!-- 	<collection property="AnnualLeave" resultMap="AnnualLeave"></collection>	 -->
		
	</resultMap>
	
	<resultMap type="AnnualLeave" id="AnnualLeave">
		<id column="ANNUAL_NO" property="annualNo"/><!-- 기본키 -->
	 	<result column="ANNUAL_COUNT" property="annualCount"/><!-- 일반컬럼 -->
	 	<result column="ANNUAL_TYPE" property="annualType"/>
	 	<result column="ANNUAL_REGI_DATE" property="annualRegiDate"/>
	 	<result column="M_ID" property="mId"/>
	</resultMap>
	<resultMap type="LeaveRecode" id="LeaveRecodeResultSet">
		<id column="LEAVE_USE_DATE" property="leaveUseDate" />
		<id column="M_ID" property="mId"/>
		<result column="LEAVE_REASON" property="leaveReason"/>
		<result column="LEAVE_TYPE" property="leaveType"/>
		<result column="LEAVE_STATUS" property="leaveStatus"/>
		<result column="ENROLL_DATE" property="enrollDate"/>
		<result column="form_name" property="formName"/>
		<result column="leave_name" property="leaveName"/>
		<result column="leaveNum" property="leaveNum"/>
		<result column="usedLeave" property="usedLeave"/>
		
	
	</resultMap>
	
	
	
  	<select id="selectLrCount" parameterType="string" resultType="_int">
  		<!-- <![CDATA[
  		select DISTINCT(SELECT SUM(annual_count) 
                  FROM annual_leave a
                  where a.m_id = #{id}
                  group by a.m_id) totalLeave,
       (select count(*)
                  from leave_recode l
                  where l.m_id = #{id}
                        and leave_status = '승인'
                        and leave_use_date <= sysdate) usedLeave, 
       (SELECT SUM(annual_count) 
                 FROM annual_leave a
                 where a.m_id = #{id}
                 group by a.m_id) - (select count(*)
                                    from leave_recode l
                                    where l.m_id = #{id}
                                          and leave_status = '승인'
                                          and leave_use_date <= sysdate) restLeveCount                 
		from leave_recode l
		 where l.m_id = #{id}
		 ]]> 
 -->
 
	<![CDATA[
		select count(*) usedLeave
        from leave_recode 
        where m_id = #{id}
              and leave_status = '승인'
              and leave_use_date <= sysdate
	]]> 
  	</select>
  	<select id="selectUsedCount" parameterType="string" resultMap="lrResultSet">
  		<!-- select sum(annual) usedLeave
		from         
		(select al.m_id,annual_count, form_name, d.doc_num,d.DOC_START_DATE, d.DOC_END_DATE, m.m_name, (DOC_END_DATE-DOC_START_DATE+1) annual
		from annual_leave al
		    left join member m on (m.m_id = al.m_id)
		    left join document d on (m.m_id = d.DRAFTER_M_ID)
		    left join document_form df on (d.form_num = df.form_num)
		where al.m_id = #{id}
		     and df.form_num = 4
		     and d.DOC_APPROVAL_STATUS = 2)
		group by m_id   -->
		select sum((LEAVE_END_DATE-LEAVE_START_DATE)) usedLeave
		from leave_recode    
		where m_id = #{id}
		    and LEAVE_STATUS = 2
		 group by m_id 
  	</select>
  	<!-- annualLeaveMain에 최신 3개글만 조회되게 하기 -->
	<select id="selectAnnualList" resultMap="LeaveRecodeResultSet"> 
	<![CDATA[
		select rownum,doc_num leaveNum, DOC_NAME leave_name, DOC_CONTENT LEAVE_REASON, DOC_CREATE_DATE ENROLL_DATE,DOC_APPROVAL_STATUS LEAVE_STATUS,  
       form_name
		from       
		(select doc_num,DOC_NAME, DOC_CONTENT, DOC_CREATE_DATE,DOC_APPROVAL_STATUS,  DOC_START_DATE,DOC_END_DATE,df.form_name,
		        (DOC_END_DATE-DOC_START_DATE+1) annual
		 from document d
		    left join document_form df on (d.form_num = df.form_num)
		 where DRAFTER_M_ID = #{id}
		        and df.form_num = 4
		 order by DOC_NUM desc)
		where rownum <= 3
	]]>	
	</select>
	<select id="getAnnualListCount" resultType="_int">
		select count(*)
			from document
			where DRAFTER_M_ID = #{id}
			    and form_num = 4
	
	</select>
	<!-- 페이징처리하여 게시글 불러오기 -->
	<select id="getSelectAnnualList" resultMap="LeaveRecodeResultSet">
		select doc_num leaveNum, doc_content leave_reason, DOC_APPROVAL_STATUS LEAVE_STATUS,DOC_CREATE_DATE ENROLL_DATE, df.form_name form_name,d.doc_name leave_name
		from document d
            left join document_form df on (d.form_num = df.form_num)
            left join member m on (d.DRAFTER_M_ID = m.m_id)
		where d.form_num=4
            and DRAFTER_M_ID = #{id}
		order by doc_num desc	
	</select>
	<select id="getAnnualSearchResultListCount" resultType="_int">
		select count(*)
		from document d
            left join document_form df on (d.form_num = df.form_num)
            left join member m on (d.DRAFTER_M_ID = m.m_id)
		where d.form_num=1
            and DRAFTER_M_ID = #{id}
		<if test="condition == 'status'">
			and DOC_APPROVAL_STATUS=to_number(#{value})
		</if>
		<if test="condition == 'title'">
			and DOC_NAME like '%' || #{value} || '%'
		</if>
		<if test="condition == 'content'">
			 and DOC_CONTENT like '%' ||#{value} || '%'
		</if>	  
	</select>
	<select id="selectSearchAnnualResultList" resultMap="LeaveRecodeResultSet">
		select doc_num leaveNum, doc_content leave_reason, DOC_APPROVAL_STATUS LEAVE_STATUS,DOC_CREATE_DATE ENROLL_DATE, df.form_name form_name,d.doc_name leave_name
		from document d
            left join document_form df on (d.form_num = df.form_num)
            left join member m on (d.DRAFTER_M_ID = m.m_id)
		where d.form_num=4
            and DRAFTER_M_ID = #{id}			
		<choose>
			<when test="condition == 'status'">
				and DOC_APPROVAL_STATUS=to_number(#{value})
			</when>
			<when test="condition == 'title'">
				and DOC_NAME like '%' || #{value} || '%'
			</when>
			<otherwise>
				 and DOC_CONTENT like '%' ||#{value} || '%'
			</otherwise>
		</choose>
		order by doc_num desc
	</select>
  
  
</mapper>
